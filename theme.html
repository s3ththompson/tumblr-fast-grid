<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	{block:PostTitle}
		<meta property="og:title" content="{PostTitle}"/>
	{/block:PostTitle}

	<title>{Title}{block:PostTitle} • {PostTitle}{/block:PostTitle}</title>

	<link rel="shortcut icon" href="{Favicon}">
	<link rel="alternate" type="application/rss+xml" href="{RSS}">

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

	{block:IndexPage}
	<script type="text/javascript">
		(function ( $ ) {
		$.fn.resize = function(maxWidth) {
			function applyResize($img, w, h, maxWidth) {
				var ratio = maxWidth / w;
				var newWidth = w * ratio;
				var newHeight = h * ratio;
				$img.attr("width", newWidth).attr("height", newHeight)
					.attr("style", "width:" + newWidth + "px !important; height:auto;");
			}
			
			return this.each(function(){
				var img = this;
				var $img = $(img);
				var w = $img.attr("width");
				var h = $img.attr("height");
				
				// Get dimensions from attributes, natural dimensions, or properties
				if (!w || !h || w === "NaN" || h === "NaN") {
					w = img.naturalWidth || img.width;
					h = img.naturalHeight || img.height;
				}
				
				// If dimensions still unavailable, wait for image to load
				if (!w || !h) {
					$img.one("load", function() {
						var nw = this.naturalWidth || this.width;
						var nh = this.naturalHeight || this.height;
						if (nw && nh) {
							applyResize($(this), nw, nh, maxWidth);
						}
					});
					return;
				}
				
				applyResize($img, w, h, maxWidth);
			});
		};
		}( jQuery ));

		function pathAtIndex(index) {
			var url = new URL(window.location.href);
			var segments = url.pathname.split('/').filter(function(segment) {
				return segment.length > 0;
			});
			var found = false;
			for (var i = 0; i < segments.length; i++) {
				if (segments[i] == "page") {
					found = true;
					if ((i + 1) < segments.length) {
						segments[(i+1)] = index.toString();
					} else {
						segments.push(index.toString());
					}
				}
			}
			if (!found) {
				segments.push("page", index.toString());
			}
			
			return '/' + segments.join('/');
		}

		function insertPage(index, postFilter) {
			return $.ajax({
				url: pathAtIndex(index)
			}).done(function(responseText) {
				$posts = $("<div>").append($.parseHTML(responseText)).find("#container .post");
				$posts.each(function(){
					$("#container").append(postFilter($(this)));
				});
			});
		}

		$(function(){
			var n = 3;
			var margin = 10;
			var width = $("#container").width();
			var column = (width - (n * margin)) / n;

			function fetch(index) {
				return insertPage(index, function($post){
					$post.find("img").resize(column).one("load", function(){
						$(this).fadeTo("fast", 1);
					}).each(function() {
					  if(this.complete) $(this).load();
					});
					return $post;
				});
			}

			var chars = ["◡◡", "⊙⊙", "◠◠"];
			var i = 0;
			var $loading = $(".loading");
			window.setInterval(function(){
				$loading.html(chars[i++ % chars.length]);
			}, 200);

			$("body, html").scrollTop($(".bar").height() + margin);
			$('.bar').css("opacity", 1);

			$("img").resize(column).one("load", function(){
				$(this).fadeTo("fast", 1);
			}).each(function() {
			  if(this.complete) $(this).load();
			});

			$("#container").waterfall({ 
				colMinWidth: column, 
				defaultContainerWidth: width,
				autoresize: true
			});

			setInterval(function () {
				if (width != $("#container").width()){
					width = $("#container").width();
					column = (width - (n * margin)) / n;
					$("img").resize(column);
					$("#container").waterfall({ 
						colMinWidth: column, 
						defaultContainerWidth: width,
						autoresize: true
					});
				}
			}, 100);

			var index = 1;
			var fetching = 0;
			setInterval(function () {
				var ScrollTopNumber = $(".post").last().offset().top - (3 * $(window).height());
				if ($(window).scrollTop() > ScrollTopNumber){
					if (fetching >= index) return;
					fetching = index;
					fetch(index + 1).done(function(){
						index++
					});
				}
			}, 300);
		});
	</script>

	{/block:IndexPage}

	<style type="text/css">
		body {
			font-family: "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
			font-size: 16px;
			color: #1d1e19;
			margin: 8px;
		}

		{block:IndexPage;}
		body {
			margin-right: 0px;
		}
		{/block:IndexPage}

		a {
			color: {AccentColor};
		}

		.copyright {
			float: right;
		}
		
		.bar {
			margin-bottom: 10px;
			color: #999;
			opacity: 0;
		}

		.bar a {
			color: #999;
		}

		.bar span, .bar a {
			margin-right: 10px;
		}

		.notes {
			position: absolute;
			bottom: 22px;
			left: 10px;
		}

		.post:hover a {
			display: inline;
		}

		.notes a {
			color: white;
			text-decoration: none;
			background: rgba(0, 0, 0, 0.2);
			padding: 2px 4px;
			display: none;
		}

		.post img {
			display: block;
			margin: 0 0 10px 0;
			max-width: 100%;
		}

		.index .post img {
			opacity: 0;
		}

		.single .post img {
			float: left;
			max-width: 100%;
		}

		.single .post .caption {
			float: left;
			margin-left: 10px;
		}

		blockquote {
			margin: 0;
		}

		.index .post p {
			display: none;
		}

		.post-content div.npf_row+div.npf_row, .post-content div.npf_row+figure.tmblr-full, .post div.npf_row+div.npf_row, .post div.npf_row+figure.tmblr-full, body div.npf_row+div.npf_row, body div.npf_row+figure.tmblr-full {
			margin-top: unset;
		}

		.post-content div.npf_row, .post div.npf_row, body div.npf_row {
			display: block;
		}

		.post-content div.npf_row .npf_col figure img, .post div.npf_row .npf_col figure img, body div.npf_row .npf_col figure img {
			width: unset;
			height: unset;
			object-fit: unset;
		}

		{CustomCSS}
	</style>
</head>
<body>
	{block:IndexPage}
	<div id="container" class="index">
		<div class="bar title" data-float="left" data-span="1">
			<span>{Title}</span>
		</div>

		<div class="bar nav" data-float="right" data-span="2">
			<a href="/archive">Archive</a>
			{block:TagPage}<span>#{Tag}</span>{/block:TagPage}
			<span>p. {CurrentPage} of {TotalPages}</span>
		</div>
	{block:Posts}

		{block:Photoset}
		<div class="post photoset">

			{block:Photos} 
			<a href="{permalink}">
				<img src="{PhotoURL-500}" width="{PhotoWidth-500}" height="{PhotoHeight-500}" border="0" />
			</a>
			{/block:Photos}
			<span class="notes">
				<a href="{ReblogURL}">↺</a>
			</span>
		</div>
		{/block:Photoset}

		{block:Photo}
		<div class="post photo">

			<a href="{Permalink}"><img src="{PhotoURL-500}" width="{PhotoWidth-500}" height="{PhotoHeight-500}" border="0" /></a>
			<span class="notes">
				<a href="{ReblogURL}">↺</a>
			</span>
		</div>
		{/block:Photo}

		{block:Text}
        <div class="post text">
            {Body}
            <span class="notes">
                <a href="{ReblogURL}">↺</a>
            </span>
        </div>
        {/block:Text}

	{/block:Posts}

	</div>
	<div class="bar footer">
		<span class="loading"></span>
		<span class="copyright">© {CopyrightYears}</span>
    </div>
	<script src="https://static.tumblr.com/3dxzzek/XN1nwfp2g/jquery.waterfall.js"></script>
	{/block:IndexPage}

	{block:PermalinkPage}
	<div id="container" class="single">

	{block:Posts}
		{block:Photoset}

		<div class="post photoset">
		{Photoset-500}

		{block:Caption}
		<div class="caption">{Caption}</div>
		{/block:Caption}

		</div>
		{/block:Photoset}

		{block:Photo}
		<div class="post photo">
			{LinkOpenTag}<img src="{PhotoURL-HighRes}" border="0"/>{LinkCloseTag}

			{block:Caption}
				<div class="caption">{Caption}</div>
			{/block:Caption}
		</div>
		{/block:Photo}

		{block:Text}
        <div class="post text">
            {Body}
        </div>
        {/block:Text}


	{/block:Posts}
	</div>
	{/block:PermalinkPage}
</body>
</html>